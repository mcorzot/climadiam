---
title: "climadiam: Paquete R para consultar datos clim√°ticos de Andaluc√≠a"
author: "Mariano Corzo Toscano"
date: "2025-11-13"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    theme: cerulean
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(ggplot2)
library(dplyr)
```

# ‚ú® Resumen

Primera versi√≥n del paquete **climadiam** para conectar con los
servicios web del Subsistema de Climatolog√≠a Ambiental (REDIAM). Permite
consultar datos de estaciones meteorol√≥gicas de Andaluc√≠a de forma
sencilla desde R.

# üåç Descripci√≥n general

El paquete permite conectarse al Subsistema CLIMA y facilita el acceso a
datos meteorol√≥gicos y ambientales, incluyendo:

-   Estaciones, variables, magnitudes y unidades
-   Datos intradiarios, diarios, mensuales y anuales
-   Intervalos temporales y fechas espec√≠ficas

------------------------------------------------------------------------

# üöÄ Instalaci√≥n y carga del paquete

```{r install, collapse=TRUE}
# Instalar 'remotes' si no est√° instalado
if (!requireNamespace("remotes", quietly = TRUE)) {
  install.packages("remotes")
}
# Instalar 'climadiam' desde GitHub solo si no est√° instalado
if (!requireNamespace("climadiam", quietly = TRUE)) {
  remotes::install_github("mcorzot/climadiam")
}
```

```{r load, collapse=FALSE}
# Cargar el paquete
library(climadiam)
```

------------------------------------------------------------------------

# üîë Acceso como usuario libre

```{r credentials, collapse=FALSE}
user <- "usuario"
password <- "usuario"
idsesion <- getwsIDSesion(user, password)
```

# üß© Funcionalidades principales

-   Conexi√≥n a los servicios web del Subsistema CLIMA.
-   Consulta de tablas maestras: comarcas, provincias, redes, variables,
    estaciones.
-   Descarga de datos intradiarios, diarios y mensuales.
-   Obtenci√≥n de intervalos temporales y fechas espec√≠ficas.
-   Compatible con entornos RStudio y scripts automatizados.
-   En caso de realizar trabajos para la Junta de Andaluc√≠a o como socio de la 
    Rediam, puede solicitar usuario avanzado.

------------------------------------------------------------------------

# üìö Ejemplos b√°sicos de uso

```{r examples_basic, collapse=FALSE}
estaciones <- getwsEstacionesList(idsesion)
head(estaciones)
datos <- getwsDatosDiarios(idsesion, "EARM22", "TD1", "26/10/2025")
head(datos)
```

------------------------------------------------------------------------

# üß™ Ejemplo pr√°ctico de acceso a datos: selecci√≥n de fechas, variables y estaciones 

Obtenci√≥n de fechas de ayer y antes de ayer: 

```{r example_full_dates, collapse=FALSE}
# Obtenci√≥n de fechas a utilizar
date1 <- Sys.Date() - 1
date1_char <- format(date1, "%d/%m/%Y")
date1_char
date2 <- Sys.Date() - 2
date2_char <- format(date2, "%d/%m/%Y")
date2_char

```

Existencias de datos para la fecha de referencia (antes de ayer): 

```{r example_full_exist, collapse=FALSE}
# Existencias de datos (tomando como referencia el d√≠a - 2)
existencias <- getwsDatosExisteEstacionesList(idsesion)
existencias$FECINICIODATOS <- as.Date(existencias$FECINICIODATOS)
existencias$FECFINDATOS <- as.Date(existencias$FECFINDATOS)
sel_existencias <- existencias[!is.na(existencias$CESTACION) & !is.na(existencias$FECINICIODATOS) & existencias$FECINICIODATOS < date2 & existencias$FECFINDATOS > date2, ]
head(sel_existencias[,c('CESTACION','FECINICIODATOS','FECFINDATOS')])
```

Estaciones (teniendo en cuenta existencias) y variables: 

```{r example_full_est_vars, collapse=FALSE}
# Caracter√≠sticas b√°sicas de las estaciones seleccionadas
estaciones     <- getwsEstacionesList(idsesion)
sel_estaciones <- estaciones[estaciones$CESTACION %in% sel_existencias$CESTACION, ]
head(sel_estaciones[,c('CESTACION','DENOMINACION','LATITUD','LONGITUD')])

# Caracter√≠sticas de las variables seleccionadas
cvariables <- c("TI1", "PI1", "TD1", "TD2", "TD4","PD23")
variables <- data.frame()
for (cvariable in cvariables) {
  sel_variables <- getwsVariables(cvariable, idsesion)
  variables <- rbind(variables, sel_variables)
}
head(variables[,c('CVARIABLE','DENOMINACION')])
```

# üß™ Ejemplo pr√°ctico de acceso a datos intradiarios de ayer

Se usa la funci√≥n "getwsDatosIntradiariosMulti" que requiere los **identificadores** de los par√°metros de la consulta

```{r example_full_intra, collapse=TRUE, eval=FALSE}
# Datos intradiarios
cvariables_int <- c("TI1","HI1")
fechas_int <- date1_char
datos_intradiarios1 <- data.frame()
# Fragmentar la consulta por red para evitar saturar el servicio
for (i in 1:length(unique(sel_estaciones$REDPKRED))) {
  sel_estaciones_red <- sel_estaciones[sel_estaciones$REDPKRED == sel_estaciones$REDPKRED[i],]
  sel_cestaciones <- sel_estaciones_red$CESTACION
  sel_datos_intradiarios1 <- getwsDatosIntradiariosMulti(idsesion, sel_cestaciones, cvariables_int, fechas_int)
  datos_intradiarios1 <- rbind(datos_intradiarios1,sel_datos_intradiarios1)
}
head(datos_intradiarios1)
print("Esto no se ejecuta")
```
# üß™ Alternativa de acceso a datos intradiarios de ayer en caso de inestabilidad del servicio

Se usa la funci√≥n "getwsDatosIntradiariosMultiRaw" que requiere los **identificadores internos** de los par√°metros de la consulta

```{r example_full_intra2, collapse=FALSE}
# Obtener identificadores internos de las variables intradiarias
cvariables_int <- c("TI1","HI1")
variables <- getwsVariablesList(idsesion) # lista de variables
sel_variables <- variables[variables$CVARIABLE %in% cvariables_int,]
pkvars_int <- sel_variables$PKVAR

# Obtener identificadores internos de las fechas
date1      <- Sys.Date() - 1
date1_char <- format(date1, format = "%d/%m/%Y")
fechas <- getwsFechasList(idsesion)
fecha <- fechas[fechas$FECHA == date1_char,]
pkfec_int <- sel_fecha1$PKFEC
pkfec_int_prev <- as.numeric(sel_fecha1$PKFEC) - 1 # pkfec del d√≠a previo

# Obtener lista de estaciones para luego iterar por ellas
estaciones <- getwsEstacionesList(idsesion) # lista de estaciones
sel_estaciones <- estaciones[estaciones$CESTACION %in% sel_existencias$CESTACION, ]
# Se descartan las estaciones PART003 y CAHA01 dado que el servicio falla al devolver datos con
# intervalos de medida inferiores a 10 minutos
sel_estaciones <- sel_estaciones[sel_estaciones$CESTACION != "PART003", ]
sel_estaciones <- sel_estaciones[sel_estaciones$CESTACION != "CAHA01", ]

# Se crea dataframe en blanco para almacenar los datos
datos_intradiarios1_alt <- data.frame()

# Consulta con la funci√≥n "getwsDatosIntradiariosMultiRaw" y los identificadores internos
# Se obtienen datos del d√≠a objetivo y el d√≠a previo ya que en CLIMA el dato del d√≠a 1 a las 00:00
# se almacena como el dato de las 24:00 del d√≠a anterior
# Fragmentar la consulta por red para evitar saturar el servicio
for (red in unique(sel_estaciones$REDPKRED)) {
  sel_estaciones_red <- subset(sel_estaciones, REDPKRED == red)
  sel_pkests    <- sel_estaciones_red$PKEST
  # Consulta d√≠a previo
  sel_datos_intradiarios1_alt_prev <- getwsDatosIntradiariosMultiRaw(idsesion,sel_pkests,pkvars_int,pkfec_int_prev)
  # Consulta d√≠a objetivo
  sel_datos_intradiarios1_alt <- getwsDatosIntradiariosMultiRaw(idsesion,sel_pkests,pkvars_int,pkfec_int)
  # Se anexan los resultados
  datos_intradiarios1_alt <- rbind(datos_intradiarios1_alt,sel_datos_intradiarios1_alt_prev,sel_datos_intradiarios1_alt)
}
head(datos_intradiarios1_alt)

# Se borran los registros en blanco derivados de la estructura de la respuesta del servicio
datos_intradiarios1_alt <- datos_intradiarios1_alt[complete.cases(datos_intradiarios1_alt), ]

# Obtenidos los datos en bruto, se relacionan con las tablas maestras
# Se relaciona con las horas-minutos
datos_intradiarios1_alt <- merge(x = datos_intradiarios1_alt, y = minutos_horas, by.x='minuto', by.y='MINUTOS')

# Se convierte el dato de las 24:00 en el de las 00:00 del dia siguiente
datos_intradiarios1_alt$HORA[datos_intradiarios1_alt$HORA=="24:00"] <- "00:00"
datos_intradiarios1_alt$pkfec <- ifelse(datos_intradiarios1_alt$HORA %in% "00:00", as.character(as.integer(datos_intradiarios1_alt$pkfec)+1), datos_intradiarios1_alt$pkfec)

# Se filtra teniendo en cuenta la fecha indicada en la consulta
datos_intradiarios1_alt <- datos_intradiarios1_alt[datos_intradiarios1_alt$pkfec %in% pkfec_int,]

# Se borran duplicados si los hubiera
datos_intradiarios1_alt <- datos_intradiarios1_alt[!duplicated(datos_intradiarios1_alt), ]

# Se ordena el dataframe por hora
datos_intradiarios1_alt <- datos_intradiarios1_alt[order(datos_intradiarios1_alt$pkest,datos_intradiarios1_alt$pkvar,datos_intradiarios1_alt$pkfec,datos_intradiarios1_alt$HORA),]

# Se asocian los identificadores internos con los valores aportados en la funcion
datos_intradiarios1_alt <- merge(x = datos_intradiarios1_alt, y = estaciones, by.x = 'pkest', by.y = 'PKEST')
datos_intradiarios1_alt <- merge(x = datos_intradiarios1_alt, y = variables, by.x = 'pkvar', by.y = 'PKVAR')
datos_intradiarios1_alt <- merge(x = datos_intradiarios1_alt, y = fechas, by.x = 'pkfec', by.y = 'PKFEC')

# Se compone el dataframe
datos_intradiarios1_alt <- data.frame(datos_intradiarios1_alt$CESTACION,datos_intradiarios1_alt$CVARIABLE,datos_intradiarios1_alt$FECHA,datos_intradiarios1_alt$HORA,datos_intradiarios1_alt$valor)
colnames(datos_intradiarios1_alt) <- c('cestacion','cvariable','fecha','hora','valor')
head(datos_intradiarios1_alt)

```

# üß™ Ejemplo pr√°ctico de acceso a datos diarios antes de ayer

Se usa la funci√≥n "getwsDatosDiariosMulti" que requiere los **identificadores** de los par√°metros de la consulta

```{r example_full_dia, collapse=TRUE, eval=FALSE}
# Datos diarios
cestaciones <- sel_existencias$CESTACION
cvariables_dia <- c("TD1","TD2","TD4","PD23")
fechas_dia <- date2_char
datos_diarios2 <- getwsDatosDiariosMulti(idsesion, cestaciones, cvariables_dia, fechas_dia)
head(datos_diarios2)
print("Esto no se ejecuta")
```
# üß™ Ejemplo pr√°ctico de acceso a datos diarios antes de ayer

Se usa la funci√≥n "getwsDatosDiariosMultiRaw" que requiere los **identificadores internos** de los par√°metros de la consulta

```{r example_full_dia2, collapse=FALSE}
# Obtener identificadores internos de las variables diarias
cvariables_dia <- c("TD1","TD2","TD4","PD23")
variables <- getwsVariablesList(idsesion) # lista de variables
sel_variables_dia <- variables[variables$CVARIABLE %in% cvariables_dia,]
pkvars_dia <- sel_variables_dia$PKVAR

# Obtener identificadores internos de las fechas
fechas_dia <- date2_char
date2_char <- format(date2, format = "%d/%m/%Y")
fechas <- getwsFechasList(idsesion)
fecha <- fechas[fechas$FECHA == date2_char,]
pkfec_dia <- fecha$PKFEC

# Obtener lista de estaciones para luego iterar por ellas
estaciones <- getwsEstacionesList(idsesion) # lista de estaciones
sel_estaciones <- estaciones[estaciones$CESTACION %in% sel_existencias$CESTACION, ]
# Se descartan las estaciones PART003 y CAHA01 dado que el servicio falla al devolver datos con
# intervalos de medida inferiores a 10 minutos
sel_estaciones <- sel_estaciones[sel_estaciones$CESTACION != "PART003", ]
sel_estaciones <- sel_estaciones[sel_estaciones$CESTACION != "CAHA01", ]

# Se crea dataframe en blanco para almacenar los datos
datos_diarios2_alt <- data.frame()

# Consulta con la funci√≥n "getwsDatosDiariosMultiRaw" y los identificadores internos
# Se obtienen datos del d√≠a objetivo y el d√≠a previo ya que en CLIMA el dato del d√≠a 1 a las 00:00
# se almacena como el dato de las 24:00 del d√≠a anterior
# Fragmentar la consulta por red para evitar saturar el servicio
for (red in unique(sel_estaciones$REDPKRED)) {
  sel_estaciones_red <- subset(sel_estaciones, REDPKRED == red)
  sel_pkests    <- sel_estaciones_red$PKEST
  # Consulta d√≠a objetivo
  sel_datos_diarios2_alt <- getwsDatosDiariosMultiRaw(idsesion,sel_pkests,pkvars_dia,pkfec_dia)
  # Se anexan los resultados
  datos_diarios2_alt <- rbind(datos_diarios2_alt,sel_datos_diarios2_alt)
}
head(datos_diarios2_alt)

# Se ordena el dataframe por estaci√≥n, variable y fecha
datos_diarios2_alt <- datos_diarios2_alt[order(datos_diarios2_alt$pkest,datos_diarios2_alt$pkvar,datos_diarios2_alt$pkfec),]

# Se asocian los identificadores internos con los valores aportados en la funcion
datos_diarios2_alt <- merge(x = datos_diarios2_alt, y = estaciones, by.x = 'pkest', by.y = 'PKEST')
datos_diarios2_alt <- merge(x = datos_diarios2_alt, y = variables, by.x = 'pkvar', by.y = 'PKVAR')
datos_diarios2_alt <- merge(x = datos_diarios2_alt, y = fechas, by.x = 'pkfec', by.y = 'PKFEC')

# Se compone el dataframe
datos_diarios2_alt <- data.frame(datos_diarios2_alt$CESTACION,datos_diarios2_alt$CVARIABLE,datos_diarios2_alt$FECHA,datos_diarios2_alt$valor)
colnames(datos_diarios2_alt) <- c('cestacion','cvariable','fecha','valor')
head(datos_diarios2_alt)
```

------------------------------------------------------------------------

# üìä Visualizaci√≥n de ejemplo

```{r plot_example, collapse=TRUE}
# Selecci√≥n de las cuatro primeras series y crear una columna de fecha-hora combinada
cestaciones_graph <- unique(datos_intradiarios1_alt$cestacion)[1:4]
datos_int <- datos_intradiarios1_alt %>%
  mutate(datetime = as.POSIXct(paste(fecha, hora), format = "%d/%m/%Y %H:%M")) %>%
  filter(cestacion %in% cestaciones_graph & cvariable %in% c("TI1", "HI1"))

# Crear el gr√°fico de temperaturas intradiarias por estaci√≥n
ggplot(datos_int, aes(x = datetime, y = valor, color = cvariable, group = cvariable)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  facet_wrap(~ cestacion, scales = "free_y") +
  labs(
    title = "Evoluci√≥n intradiaria de Temperatura (TI1) y Humedad (HI1)",
    x = "Fecha y hora",
    y = "Valor",
    color = "Variable"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "bottom"
  )

# Selecci√≥n de datos de TD1
datos_dia <- datos_diarios2_alt[datos_diarios2_alt$cvariable == 'TD2',]
# Histograma de frecuencias de datos de temperatura diaria
ggplot(datos_dia, aes(x = valor)) +
  geom_histogram(binwidth = 1, fill = "#2b8cbe", color = "white", alpha = 0.8) +
  labs(
    title = "Distribuci√≥n de valores de TD2",
    x = "Valor de TD2",
    y = "Frecuencia"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5)
  )
```

------------------------------------------------------------------------

# üßë‚Äçüíª Autor√≠a y contacto

Desarrollado por **mcorzot**. Repositorio oficial:
<https://github.com/mcorzot/climadiam>
